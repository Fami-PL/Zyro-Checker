<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zyro-Checker - Analizator ModÃ³w do Minecrafta</title>
    <style>
        :root {
            --bg-color: #000000;
            --surface-color: #0c0c0c;
            --primary-color: #ffffff;
            --primary-hover: #e0e0e0;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --border-color: #333333;
            --success-color: #ffffff;
            --error-color: #ef4444;
            --btn-glow: 0 0 10px rgba(255, 255, 255, 0.2);
            --btn-glow-hover: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--surface-color);
            padding: 1.5rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin: 0;
            font-size: 2rem;
            color: var(--primary-color);
            letter-spacing: 0.05em;
        }

        p.subtitle {
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        main {
            flex: 1;
            padding: 2rem;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .upload-section {
            background-color: var(--surface-color);
            border: 2px dashed var(--border-color);
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .upload-section:hover,
        .upload-section.dragover {
            border-color: var(--primary-color);
            background-color: #111111;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .file-input {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .btn {
            background-color: #000000;
            color: var(--primary-color);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: var(--btn-glow);
        }

        .btn:hover {
            background-color: #111111;
            border-color: var(--primary-color);
            box-shadow: var(--btn-glow-hover);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-success {
            border-color: var(--primary-color);
        }

        .btn-success:hover {
            background-color: #1a1a1a;
        }

        .lang-switch {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            display: flex;
            gap: 0.5rem;
            background: #000;
            border: 1px solid var(--border-color);
            padding: 0.25rem;
            border-radius: 0.5rem;
        }

        .lang-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: bold;
            transition: all 0.2s;
        }

        .lang-btn.active {
            background: var(--primary-color);
            color: #000;
            box-shadow: var(--btn-glow);
        }

        .search-input {
            width: 100%;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 0.5rem;
            box-sizing: border-box;
            margin-top: 0.5rem;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: var(--btn-glow);
        }


        .results-section {
            display: none;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }

        .results-section.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .workspace-container {
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
            margin-top: 1.5rem;
        }

        .sidebar {
            flex: 0 0 320px;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            display: flex;
            flex-direction: column;
            height: 600px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .sidebar-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .sidebar-header p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .file-list {
            overflow-y: auto;
            flex: 1;
            padding: 0.5rem;
        }

        .file-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
            word-break: break-all;
            font-size: 0.85rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .file-item:hover {
            background-color: var(--border-color);
        }

        .file-item input[type="checkbox"] {
            margin-right: 0.5rem;
            cursor: pointer;
            transform: scale(1.2);
        }

        .file-suspect {
            color: var(--error-color);
            font-weight: bold;
        }

        .highlight-red {
            color: var(--error-color);
            background-color: rgba(239, 68, 68, 0.1);
            font-weight: bold;
            padding: 0 2px;
            border-radius: 3px;
        }

        .highlight-warning {
            color: #fecaca;
            background-color: rgba(239, 68, 68, 0.2);
            font-weight: bold;
            display: block;
            border-left: 4px solid var(--error-color);
            padding: 0.5rem;
            margin: 1rem 0;
            white-space: pre-wrap;
        }

        .code-container {
            flex: 1;
            background-color: #050505;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            overflow: hidden;
            position: relative;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .code-header {
            background-color: var(--surface-color);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .code-title {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        pre {
            margin: 0;
            padding: 1.5rem;
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            color: #e2e8f0;
        }

        pre::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        pre::-webkit-scrollbar-track {
            background: #050505;
        }

        pre::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(4px);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--surface-color);
            border-left: 4px solid var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            transform: translateX(120%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1001;
        }

        .toast.show {
            transform: translateX(0);
        }

        #file-name-display {
            margin-top: 1rem;
            font-weight: bold;
            color: var(--primary-color);
        }
    </style>
</head>

<body>

    <header>
        <div class="lang-switch">
            <button class="lang-btn active" id="lang-en" onclick="setLang('en')">EN</button>
            <button class="lang-btn" id="lang-pl" onclick="setLang('pl')">PL</button>
        </div>
        <h1 id="t-title">Zyro-Checker</h1>
        <p class="subtitle" id="t-subtitle">Decompile Minecraft mod (.jar) and check if it's safe</p>
    </header>

    <main>
        <div class="upload-section" id="drop-zone">
            <div class="upload-icon">ðŸ“‚</div>
            <h2 id="t-drop-title">Drag and drop .jar file here</h2>
            <p id="t-drop-sub">or click to select from disk (e.g. Sodium.jar, OptiFine.jar)</p>
            <input type="file" id="file-input" class="file-input" accept=".jar, application/java-archive">
            <div id="file-name-display"></div>
        </div>

        <div class="results-section" id="results" style="display: none;">
            <div class="controls">
                <button class="btn btn-success" id="btn-copy-prompt">
                    <span id="t-btn-prompt">âœ¨ Copy Prompt (selected files)</span>
                </button>
                <button class="btn" id="btn-download-txt">
                    <span id="t-btn-download">ðŸ’¾ Download .TXT (selected)</span>
                </button>
                <button class="btn" id="btn-copy-code">
                    <span id="t-btn-code">ðŸ“‹ Copy code (selected)</span>
                </button>
                <button class="btn" onclick="location.reload()">
                    <span id="t-btn-reload">ðŸ”„ Upload another file</span>
                </button>
            </div>

            <div class="workspace-container">
                <div class="sidebar">
                    <div class="sidebar-header">
                        <h3 id="t-sidebar-title">Mod files</h3>
                        <p id="t-sidebar-desc">Select files/modules you want to include for AI verification.</p>
                        <input type="text" id="file-search" class="search-input"
                            placeholder="Search code or file name... ðŸ”">
                        <div style="display:flex; gap: 0.5rem; margin-top: 0.5rem;">
                            <button id="btn-select-all" class="btn"
                                style="padding: 0.25rem 0.5rem; font-size: 0.75rem; box-shadow: none;">
                                <span id="t-btn-all">Select all</span>
                            </button>
                            <button id="btn-select-suspect" class="btn"
                                style="padding: 0.25rem 0.5rem; font-size: 0.75rem; border-color: var(--error-color); color: var(--error-color); box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);">
                                <span id="t-btn-suspect">Only "Suspect"</span>
                            </button>
                            <button id="btn-deselect-all" class="btn"
                                style="padding: 0.25rem 0.5rem; font-size: 0.75rem; box-shadow: none;">
                                <span id="t-btn-none">Deselect</span>
                            </button>
                        </div>
                    </div>
                    <div id="file-list" class="file-list"></div>
                </div>

                <div class="code-container">
                    <div class="code-header">
                        <span class="code-title" id="t-code-title">Decompiled Java code</span>
                    </div>
                    <pre><code id="code-output">Select a file from the list to view code...</code></pre>
                </div>
            </div>
        </div>
    </main>

    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <h2 id="loading-text">Decompilation in progress... (this may take a while)</h2>
        <p id="t-loading-desc">Running CFR Decompiler, please wait.</p>
    </div>

    <div class="toast" id="toast">Komunikat</div>

    <script>
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        const resultsSection = document.getElementById('results');
        const codeOutput = document.getElementById('code-output');
        const loadingOverlay = document.getElementById('loading');
        const btnCopyPrompt = document.getElementById('btn-copy-prompt');
        const btnDownloadTxt = document.getElementById('btn-download-txt');
        const btnCopyCode = document.getElementById('btn-copy-code');
        const toast = document.getElementById('toast');
        const searchInput = document.getElementById('file-search');

        let extractedFiles = [];
        let filteredFiles = [];
        let currentLang = 'en';

        const translations = {
            en: {
                subtitle: "Decompile Minecraft mod (.jar) and check if it's safe",
                dropTitle: "Drag and drop .jar file here",
                dropSub: "or click to select from disk (e.g. Sodium.jar, OptiFine.jar)",
                btnPrompt: "âœ¨ Copy Prompt (selected files)",
                btnDownloadTxt: "ðŸ’¾ Download .TXT (selected)",
                btnCode: "ðŸ“‹ Copy code (selected)",
                btnReload: "ðŸ”„ Upload another file",
                sidebarTitle: "Mod files",
                sidebarDesc: "Select files/modules you want to include for AI verification.",
                btnAll: "Select all",
                btnSuspect: 'Only "Suspect"',
                btnNone: "Deselect",
                codeTitle: "Decompiled Java code",
                loadingText: "Decompilation in progress... (this may take a while)",
                loadingDesc: "Running CFR Decompiler, please wait.",
                toastSelectJar: "Select a file with .jar extension",
                toastSuccess: "Decompilation successful!",
                toastError: "An error occurred during decompilation. Ensure backend is running.",
                toastCopied: "Copied code to clipboard!",
                toastNoFile: "No file selected (check modules from the list)",
                toastLengthWarn: "Warning: You selected too many files. Code might be truncated for ChatGPT!",
                toastPromptReady: "Prompt ready! Paste it to ChatGPT or Gemini.",
                toastDownloadStart: "Downloading prompt as .txt...",
                suspectTooltip: "Warning: Contains suspicious methods (e.g. network, files)!",
                emptyFile: "// Empty file",
                noCodeFound: "No Java source code found.",
                searchInput: "Search code or file name... ðŸ”"
            },
            pl: {
                subtitle: "Zdekompiluj mod do Minecrafta (.jar) i sprawdÅº czy jest bezpieczny",
                dropTitle: "PrzeciÄ…gnij i upuÅ›Ä‡ plik .jar tutaj",
                dropSub: "lub kliknij by wybraÄ‡ z dysku (np. Sodium.jar, OptiFine.jar)",
                btnPrompt: "âœ¨ Skopiuj Prompt (zaznaczone pliki)",
                btnDownloadTxt: "ðŸ’¾ Pobierz .TXT (zaznaczone)",
                btnCode: "ðŸ“‹ Skopiuj kod (zaznaczone)",
                btnReload: "ðŸ”„ Wgraj inny plik",
                sidebarTitle: "Pliki modyfikacji",
                sidebarDesc: "Zaznacz pliki/moduÅ‚y, ktÃ³re chcesz dodaÄ‡ do skopiowania w celu weryfikacji przez AI.",
                btnAll: "Zaznacz wszystkie",
                btnSuspect: 'Tylko "Podejrzane"',
                btnNone: "Odznacz",
                codeTitle: "Zdekompilowany kod Java",
                loadingText: "Dekompilacja w toku... (moÅ¼e to zajÄ…Ä‡ chwilÄ™)",
                loadingDesc: "Uruchamiamy CFR Decompiler, proszÄ™ czekaÄ‡.",
                toastSelectJar: "Wybierz plik z rozszerzeniem .jar",
                toastSuccess: "Dekompilacja zakoÅ„czona sukcesem!",
                toastError: "WystÄ…piÅ‚ bÅ‚Ä…d podczas dekompilacji. Upewnij siÄ™, Å¼e backend dziaÅ‚a.",
                toastCopied: "Skopiowano kod do schowka!",
                toastNoFile: "Nie zaznaczono Å¼adnego pliku (zaznacz moduÅ‚y z listy)",
                toastLengthWarn: "Uwaga: ZaznaczyÅ‚eÅ› bardzo duÅ¼o plikÃ³w. Kod moÅ¼e zostaÄ‡ przyciÄ™ty dla AI!",
                toastPromptReady: "Gotowy prompt skopiowany! Wklej go do ChatGPT lub Gemini.",
                toastDownloadStart: "RozpoczÄ™to pobieranie pliku .txt...",
                suspectTooltip: "Uwaga: Zawiera podejrzane metody (np. poÅ‚Ä…czenia sieciowe, pliki)!",
                emptyFile: "// Pusty plik",
                noCodeFound: "Nie znaleziono kodu ÅºrÃ³dÅ‚owego Java.",
                searchInput: "Szukaj kodu lub nazwy pliku... ðŸ”"
            }
        };

        function setLang(lang) {
            currentLang = lang;
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('lang-' + lang).classList.add('active');

            const t = translations[lang];
            document.getElementById('t-subtitle').textContent = t.subtitle;
            document.getElementById('t-drop-title').textContent = t.dropTitle;
            document.getElementById('t-drop-sub').textContent = t.dropSub;
            document.getElementById('t-btn-prompt').textContent = t.btnPrompt;
            document.getElementById('t-btn-download').textContent = t.btnDownloadTxt;
            document.getElementById('t-btn-code').textContent = t.btnCode;
            document.getElementById('t-btn-reload').textContent = t.btnReload;
            document.getElementById('t-sidebar-title').textContent = t.sidebarTitle;
            document.getElementById('t-sidebar-desc').textContent = t.sidebarDesc;
            document.getElementById('t-btn-all').textContent = t.btnAll;
            document.getElementById('t-btn-suspect').textContent = t.btnSuspect;
            document.getElementById('t-btn-none').textContent = t.btnNone;
            document.getElementById('t-code-title').textContent = t.codeTitle;
            document.getElementById('loading-text').textContent = t.loadingText;
            document.getElementById('t-loading-desc').textContent = t.loadingDesc;
            document.getElementById('file-search').placeholder = t.searchInput;

            if (extractedFiles.length > 0) renderFileList(); // re-render to update tooltips
        }

        // Drag and drop event listeners
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        dropZone.addEventListener('drop', handleDrop, false);
        fileInput.addEventListener('change', handleFileSelect, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (!file.name.endsWith('.jar')) {
                    showToast(translations[currentLang].toastSelectJar, true);
                    return;
                }
                fileNameDisplay.textContent = `${file.name}`;
                uploadAndDecompile(file);
            }
        }

        function uploadAndDecompile(file) {
            loadingOverlay.style.display = 'flex';

            const formData = new FormData();
            formData.append('modFile', file);

            fetch('/api/decompile', {
                method: 'POST',
                body: formData
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Serwer zwrÃ³ciÅ‚ bÅ‚Ä…d: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    loadingOverlay.style.display = 'none';
                    if (data.error) {
                        showToast(data.error, true);
                        return;
                    }

                    extractedFiles = data.files || [];
                    // add selected property
                    extractedFiles.forEach((file, index) => {
                        file.originalIndex = index;
                        file.selected = file.suspect || index < 20;
                    });

                    filteredFiles = [...extractedFiles];

                    dropZone.style.display = 'none';
                    resultsSection.style.display = 'block';

                    renderFileList();

                    // Trigger reflow
                    void resultsSection.offsetWidth;
                    resultsSection.classList.add('visible');

                    showToast(translations[currentLang].toastSuccess);
                })
                .catch(error => {
                    loadingOverlay.style.display = 'none';
                    console.error('Error:', error);
                    showToast(translations[currentLang].toastError, true);
                });
        }

        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            if (!term) {
                filteredFiles = [...extractedFiles];
            } else {
                filteredFiles = extractedFiles.filter(f =>
                    f.path.toLowerCase().includes(term) ||
                    (f.content && f.content.toLowerCase().includes(term))
                );
            }
            renderFileList();
        });

        function renderFileList() {
            const fileListEl = document.getElementById('file-list');
            fileListEl.innerHTML = '';

            const t = translations[currentLang];

            filteredFiles.forEach((file) => {
                const div = document.createElement('div');
                div.className = 'file-item';

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.checked = file.selected;
                cb.id = 'file-cb-' + file.originalIndex;

                cb.addEventListener('change', (e) => {
                    file.selected = e.target.checked;
                });

                const span = document.createElement('span');
                span.textContent = file.path;
                if (file.suspect) {
                    span.classList.add('file-suspect');
                    span.title = t.suspectTooltip;
                }

                div.appendChild(cb);
                div.appendChild(span);

                cb.addEventListener('click', (e) => e.stopPropagation());

                div.addEventListener('click', () => {
                    codeOutput.innerHTML = file.content ? highlightCode(file.content) : t.emptyFile;
                    document.querySelector('.code-title').textContent = file.path;
                });

                fileListEl.appendChild(div);
            });

            if (filteredFiles.length > 0) {
                codeOutput.innerHTML = filteredFiles[0].content ? highlightCode(filteredFiles[0].content) : t.emptyFile;
                document.querySelector('.code-title').textContent = filteredFiles[0].path;
            } else {
                codeOutput.innerHTML = t.noCodeFound;
            }
        }

        function highlightCode(code) {
            if (!code) return '';

            // 1. Zabezpieczenie przed HTML injection (escape)
            let escaped = code.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

            // 2. PodÅ›wietlanie podejrzanych sÅ‚Ã³w kluczowych (na podstawie regexu z serwera)
            const suspectRegexStr = 'java\\.net|URL|URLConnection|HttpURLConnection|Socket|ProcessBuilder|Runtime\\.getRuntime\\(\\)\\.exec|System\\.loadLibrary|ClassLoader|Base64\\.getDecoder|Cipher\\.getInstance|Files\\.write|FileOutputStream|crypto';
            const regex = new RegExp(`(${suspectRegexStr})`, 'gi');

            escaped = escaped.replace(regex, '<span class="highlight-red">$1</span>');

            // 3. PodÅ›wietlenie caÅ‚ego bloku z ostrzeÅ¼eniem od bota AI
            escaped = escaped.replace(/(\/\* \n======= AI ASSISTANT WARNING =======[\s\S]*?======================================\n\*\/)/g, '<span class="highlight-warning">$1</span>');

            return escaped;
        }

        document.getElementById('btn-select-all').addEventListener('click', () => {
            filteredFiles.forEach(f => {
                f.selected = true;
                const cb = document.getElementById('file-cb-' + f.originalIndex);
                if (cb) cb.checked = true;
            });
        });

        document.getElementById('btn-select-suspect').addEventListener('click', () => {
            filteredFiles.forEach(f => {
                f.selected = f.suspect;
                const cb = document.getElementById('file-cb-' + f.originalIndex);
                if (cb) cb.checked = f.suspect;
            });
        });

        document.getElementById('btn-deselect-all').addEventListener('click', () => {
            filteredFiles.forEach(f => {
                f.selected = false;
                const cb = document.getElementById('file-cb-' + f.originalIndex);
                if (cb) cb.checked = false;
            });
        });

        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.style.borderLeftColor = isError ? 'var(--error-color)' : 'var(--success-color)';
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function copyToClipboard(text, successMessage) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(successMessage);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                // Fallback approach
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast(successMessage);
                } catch (err) {
                    showToast('Failed to copy / Nie udaÅ‚o siÄ™ skopiowaÄ‡!', true);
                }
                document.body.removeChild(textArea);
            });
        }

        function getSelectedCodeForPrompt() {
            let combined = '';
            extractedFiles.forEach((file) => {
                if (file.selected) {
                    combined += `\n/* ===== ${file.path} ===== */\n`;
                    combined += file.content + '\n';
                }
            });
            return combined;
        }

        btnCopyCode.addEventListener('click', () => {
            const text = getSelectedCodeForPrompt();
            if (text) {
                copyToClipboard(text, translations[currentLang].toastCopied);
            } else {
                showToast(translations[currentLang].toastNoFile, true);
            }
        });

        function buildPrompt(text) {
            const promptEn = `I am a Minecraft player and downloaded a specific mod as a .jar file. I decompiled it to check its contents. 
Below is the decompiled Java code of selected important modules from this mod. Your task is to check this code for safety.
Look for malware, token loggers (Discord token grabbers), backdoors, malicious network connections, file theft, obfuscations trying to hide malicious activity, or downloading external files.
Focus on suspicious parts (e.g., java.net.*, Runtime.exec, System.loadLibrary).

Is this mod safe? What suspicious things did you find in the attached files?

Code:
=========================================================
${text}
=========================================================`;

            const promptPl = `Jestem graczem Minecrafta i pobraÅ‚em pewnego moda w formie pliku .jar. PrzeprowadziÅ‚em jego dekompilacjÄ™, aby sprawdziÄ‡ zawartoÅ›Ä‡. 
PoniÅ¼ej znajduje siÄ™ zdekompilowany kod Java wybranych, waÅ¼nych moduÅ‚Ã³w z tego moda. Twoim zadaniem jest sprawdzenie tego kodu pod kÄ…tem bezpieczeÅ„stwa.
Szukaj zÅ‚oÅ›liwego oprogramowania (malware), token loggerÃ³w (Discord token grabbers), backdoorÃ³w, zÅ‚oÅ›liwych poÅ‚Ä…czeÅ„ sieciowych, kradzieÅ¼y plikÃ³w, czy pobierania zewnÄ™trznych plikÃ³w (najczÄ™Å›ciej robione w gÅ‚Ã³wnych klasach / init).
JeÅ›li jest tego duÅ¼o, skup siÄ™ na podejrzanych fragmentach (uÅ¼ycie java.net.*, Runtime.exec, System.loadLibrary).

Czy wskazane moduÅ‚y sÄ… bezpieczne? Jakie podejrzane rzeczy znalazÅ‚eÅ› w zaÅ‚Ä…czonych plikach?

Oto zdekompilowany kod:
=========================================================
${text}
=========================================================`;

            return currentLang === 'en' ? promptEn : promptPl;
        }

        btnCopyPrompt.addEventListener('click', () => {
            let text = getSelectedCodeForPrompt();

            if (!text) {
                showToast(translations[currentLang].toastNoFile, true);
                return;
            }

            if (text.length > 400000) {
                showToast(translations[currentLang].toastLengthWarn, false);
                text = text.substring(0, 400000) + '\n...[PrzyciÄ™to kod / Code truncated]...';
            }

            const prompt = buildPrompt(text);
            copyToClipboard(prompt, translations[currentLang].toastPromptReady);
        });

        btnDownloadTxt.addEventListener('click', () => {
            let text = getSelectedCodeForPrompt();

            if (!text) {
                showToast(translations[currentLang].toastNoFile, true);
                return;
            }

            // For downloading, we don't necessarily need to crop since text files can be larger,
            // but we can leave a higher limit just in case. Let's let them download the full text.
            const prompt = buildPrompt(text);

            const blob = new Blob([prompt], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `Prompt_ZyroChecker_${Date.now()}.txt`;
            a.style.display = 'none';

            document.body.appendChild(a);
            a.click();

            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            showToast(translations[currentLang].toastDownloadStart);
        });

        // Initialize default language
        setLang('en');

    </script>
</body>

</html>